<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Single Prediction | Employee Attrition</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        /* Override some defaults for Index specifically if needed, 
           but mostly using style.css now */
        .section {
            background: rgba(255, 246, 231, 0.1);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            background: #d4a017;
            color: #000;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .section label,
        .glass-card label {
            color: #ffffff !important;
            margin-bottom: 5px;
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-premium mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='logo.png') }}" height="36" alt="Logo">
                EMPLOYEE ATTRITION SYSTEM
            </a>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-warning btn-sm fw-bold">Single</a>
                <a href="/simulation" class="btn btn-outline-light btn-sm">Simulator</a>
                <a href="/bulk" class="btn btn-outline-light btn-sm">Bulk</a>
                <a href="/dashboard" class="btn btn-outline-light btn-sm">Dashboard</a>
                {% if session.get('logged_in') %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>


    <!-- MAIN -->
    <div class="container mt-4 mb-5">
        <div class="row g-4">

            <!-- FORM -->
            <div class="col-lg-7 animate-up">
                <div class="glass-card">

                    <h3 class="fw-bold mb-2">Single Employee Prediction</h3>
                    <p class="text-white-50 mb-3">Fill employee details to predict attrition risk</p>

                    <form method="POST">

                        <!-- PERSONAL -->
                        <div class="section">
                            <div class="section-title">Personal Details</div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label>Age</label>
                                    <input type="number" name="Age" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label>Gender</label>
                                    <select name="Gender" class="form-select">
                                        <option value="">Select</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Marital Status</label>
                                    <select name="MaritalStatus" class="form-select">
                                        <option value="">Select</option>
                                        <option>Single</option>
                                        <option>Married</option>
                                        <option>Divorced</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Maternity/Paternity Leave</label>
                                    <select name="MaternityPaternityLeave" class="form-select">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- JOB -->
                        <div class="section">
                            <div class="section-title">Job Details</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label>Department</label>
                                    <select name="Department" class="form-select">
                                        <option value="">Select</option>
                                        <option>Research & Development</option>
                                        <option>Sales</option>
                                        <option>Human Resources</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Job Role</label>
                                    <select name="JobRole" class="form-select">
                                        <option value="">Select</option>
                                        <option>Research Scientist</option>
                                        <option>Sales Executive</option>
                                        <option>Laboratory Technician</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SALARY -->
                        <div class="section">
                            <div class="section-title">Salary & Compensation</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label>Monthly Income</label>
                                    <input type="number" name="MonthlyIncome" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label>Percent Salary Hike</label>
                                    <input type="number" name="PercentSalaryHike" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- EXPERIENCE -->
                        <div class="section">
                            <div class="section-title">Experience & Tenure</div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label>Total Working Years</label>
                                    <input type="number" name="TotalWorkingYears" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label>Years At Company</label>
                                    <input type="number" name="YearsAtCompany" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label>Years In Current Role</label>
                                    <input type="number" name="YearsInCurrentRole" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- SATISFACTION -->
                        <div class="section">
                            <div class="section-title">Satisfaction & Work-Life</div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label>Job Satisfaction (1â€“4)</label>
                                    <input type="number" min="1" max="4" name="JobSatisfaction" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label>Work Life Balance (1â€“4)</label>
                                    <input type="number" min="1" max="4" name="WorkLifeBalance" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label>OverTime</label>
                                    <select name="OverTime" class="form-select">
                                        <option>No</option>
                                        <option>Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label>Workplace Harassment Reported?</label>
                                    <select name="WorkplaceHarassment" class="form-select">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Remote Work Days (0-5)</label>
                                    <input type="number" min="0" max="5" name="RemoteWorkFrequency" class="form-control"
                                        value="0">
                                </div>
                            </div>
                            <div class="row g-3 mt-1">
                                <div class="col-md-4">
                                    <label>Mental Health Support?</label>
                                    <select name="MentalHealthResources" class="form-select">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Deadline Pressure (1-4)</label>
                                    <input type="number" min="1" max="4" name="ProjectDeadlinePressure"
                                        class="form-control" value="2">
                                </div>
                                <div class="col-md-4">
                                    <label>Training Hours/Month</label>
                                    <input type="number" min="0" name="SkillDevelopmentHours" class="form-control"
                                        value="5">
                                </div>
                            </div>
                        </div>

                        <button class="premium-btn w-100 mt-2">
                            ðŸ‘¤ Predict Attrition Risk
                        </button>

                    </form>
                </div>
            </div>

            <!-- RESULT -->
            <div class="col-lg-5 animate-up">
                <div class="glass-card">

                    <h4 class="fw-bold mb-3">Prediction Summary</h4>

                    {% if prediction and not prediction.error %}
                    <span
                        class="badge {{ 'badge-leave' if prediction.label=='Likely to LEAVE' else 'badge-stay' }} px-3 py-2">
                        {{ prediction.label }}
                    </span>

                    <p class="mt-3"><b>Risk Score:</b> {{ prediction.risk_score }}%</p>

                    <canvas id="riskChart" height="220"></canvas>

                    <hr>

                    <h5>AI Decision Insights (SHAP)</h5>
                    <p class="text-muted small">Factors that increased (Red) or decreased (Green) the risk score.</p>
                    <div style="height: 300px;">
                        <canvas id="shapChart"></canvas>
                    </div>

                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="getDeepExplanation()">
                            <i class="bi bi-diagram-3"></i> View Deep Explanation (Waterfall)
                        </button>
                    </div>

                    <!-- Waterfall Modal -->
                    <div class="modal fade" id="waterfallModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content glass-card p-0"
                                style="background: #0f172a; border: 1px solid #334155;">
                                <div class="modal-header border-bottom border-secondary">
                                    <h5 class="modal-title text-info">Deep Feature Explanation</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center p-4">
                                    <div id="waterfallSpinner" class="spinner-border text-info d-none"></div>
                                    <img id="waterfallImg" class="img-fluid rounded" style="display:none;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <h5>HR Recommendations</h5>
                    <ul>
                        {% for r in prediction.recommendations %}
                        <li>{{ r }}</li>
                        {% endfor %}
                    </ul>

                    {% elif prediction and prediction.error %}
                    <div class="alert alert-danger">
                        <strong>Error:</strong> {{ prediction.error }}
                    </div>
                    {% else %}
                    <p class="text-muted">Submit form to see prediction</p>
                    {% endif %}

                </div>
            </div>

        </div>
    </div>

    {% if prediction and not prediction.error %}
    <script>
        // 1. Risk Doughnut Chart
        new Chart(document.getElementById("riskChart"), {
            type: "doughnut",
            data: {
                datasets: [{
                    data: [{{ prediction.risk_score }}, 100 - {{ prediction.risk_score }}],
            backgroundColor: ["{{ prediction.chart_color }}", "#e5e7eb"],
            borderWidth: 0
        }]
            },
            options: { cutout: "70%", plugins: { legend: { display: false } } }
        });


        function getDeepExplanation() {
            const modal = new bootstrap.Modal(document.getElementById('waterfallModal'));
            modal.show();

            const spinner = document.getElementById('waterfallSpinner');
            const img = document.getElementById('waterfallImg');

            spinner.classList.remove('d-none');
            img.style.display = 'none';

            // Gather form data
            const form = document.querySelector('form');
            if (!form) return;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Number conversion
            for (const key in data) {
                if (!isNaN(data[key]) && data[key] !== "") {
                    data[key] = Number(data[key]);
                }
            }

            fetch('/api/explain_prediction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(result => {
                    spinner.classList.add('d-none');
                    if (result.image) {
                        img.src = "data:image/png;base64," + result.image;
                        img.style.display = 'block';
                    } else {
                        alert('Could not generate explanation: ' + (result.error || 'Unknown error'));
                        modal.hide();
                    }
                })
                .catch(err => {
                    console.error(err);
                    spinner.classList.add('d-none');
                    modal.hide();
                });
        }

        // 2. SHAP Feature Importance Chart
        {% if prediction.shap_data %}
        (function () {
            const shapLabels = {{ prediction.shap_data['labels'] | tojson
        }};
        const shapValues = {{ prediction.shap_data['values'] | tojson }};
        const colors = shapValues.map(v => v > 0 ? "#dc3545" : "#198754");

        new Chart(document.getElementById("shapChart"), {
            type: "bar",
            data: {
                labels: shapLabels,
                datasets: [{
                    label: "Impact", // Added label for visibility
                    data: shapValues,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return " Impact: " + context.raw;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: "#f0f0f0" },
                        ticks: { display: true }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
        }) ();
        {% endif %}
    </script>
    {% endif %}

</body>

</html>