<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Attrition Simulator | AI Project</title>
    <!-- Bootstrap + Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        .range-wrap {
            position: relative;
            margin: 0 auto 3.5rem;
        }

        .sim-control-label {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.7);
        }

        .slider-val {
            font-weight: 800;
            color: #f1c40f;
            float: right;
            font-size: 1rem;
        }

        /* Customize range sliders for premium look */
        .form-range::-webkit-slider-thumb {
            background: #f1c40f;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.4);
        }

        .form-range::-webkit-slider-runnable-track {
            background: rgba(255, 255, 255, 0.1);
        }

        #riskDisplay {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-premium mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='logo.png') }}" height="36" alt="Logo">
                ATTRITION SIMULATOR
            </a>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-outline-light btn-sm">Single</a>
                <a href="/simulation" class="btn btn-warning btn-sm fw-bold">Simulator</a>
                <a href="/bulk" class="btn btn-outline-light btn-sm">Bulk</a>
                <a href="/dashboard" class="btn btn-outline-light btn-sm">Dashboard</a>
                {% if session.get('logged_in') %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>


    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12 text-center mb-4">
                <h2 class="fw-bold">üéõÔ∏è Interactive Risk Simulator</h2>
                <p class="text-white-50">Tweak employee parameters and see how Attrition Risk changes in real-time.</p>
            </div>
        </div>

        <div class="row">
            <!-- CONTROLS -->
            <div class="col-lg-5 mb-4 animate-up">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">Simulation Controls</h5>

                    <!-- Monthly Income -->
                    <div class="mb-4">
                        <label class="sim-control-label">Monthly Income ($) <span id="val_income"
                                class="slider-val">6500</span></label>
                        <input type="range" class="form-range" id="income" min="1000" max="20000" step="100"
                            value="6500" oninput="updateSim()">
                    </div>

                    <!-- Percent Salary Hike -->
                    <div class="mb-4">
                        <label class="sim-control-label">Salary Hike (%) <span id="val_hike"
                                class="slider-val">15</span></label>
                        <input type="range" class="form-range" id="hike" min="0" max="30" step="1" value="15"
                            oninput="updateSim()">
                    </div>

                    <!-- Job Satisfaction -->
                    <div class="mb-4">
                        <label class="sim-control-label">Job Satisfaction (1-4) <span id="val_jobsat"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="jobsat" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <!-- Work Life Balance -->
                    <div class="mb-4">
                        <label class="sim-control-label">Work Life Balance (1-4) <span id="val_wlb"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="wlb" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <!-- OverTime -->
                    <div class="mb-4 d-flex justify-content-between align-items-center">
                        <label class="sim-control-label mb-0">OverTime?</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="overtime" onchange="updateSim()">
                        </div>
                    </div>

                    <!-- Remote Work -->
                    <div class="mb-4">
                        <label class="sim-control-label">Remote Work Days (0-5) <span id="val_remote"
                                class="slider-val">0</span></label>
                        <input type="range" class="form-range" id="remote" min="0" max="5" step="1" value="0"
                            oninput="updateSim()">
                    </div>

                    <hr class="my-4">
                    <h6 class="fw-bold mb-3 text-primary">Other Key Factors</h6>

                    <!-- Age -->
                    <div class="mb-3">
                        <label class="sim-control-label">Age <span id="val_age" class="slider-val">30</span></label>
                        <input type="range" class="form-range" id="age" min="18" max="60" step="1" value="30"
                            oninput="updateSim()">
                    </div>

                    <!-- Years At Company -->
                    <div class="mb-3">
                        <label class="sim-control-label">Years At Company <span id="val_tenure"
                                class="slider-val">5</span></label>
                        <input type="range" class="form-range" id="tenure" min="0" max="40" step="1" value="5"
                            oninput="updateSim()">
                    </div>

                    <!-- Distance From Home -->
                    <div class="mb-3">
                        <label class="sim-control-label">Distance From Home (km) <span id="val_dist"
                                class="slider-val">9</span></label>
                        <input type="range" class="form-range" id="dist" min="1" max="30" step="1" value="9"
                            oninput="updateSim()">
                    </div>

                    <!-- Environment Satisfaction -->
                    <div class="mb-3">
                        <label class="sim-control-label">Environment Sat. (1-4) <span id="val_env"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="env" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <button class="premium-btn w-100 mt-2" onclick="resetDefaults()">Reset Defaults</button>

                </div>
            </div>

            <!-- VISUALIZATION -->
            <div class="col-lg-7 animate-up" style="animation-delay: 0.2s;">
                <div class="glass-card h-100 d-flex flex-column justify-content-center align-items-center text-center">

                    <h4 class="text-white-50 mb-1">Predicted Attrition Risk</h4>
                    <h1 class="display-1 fw-bold mb-3" id="riskDisplay">--%</h1>

                    <div style="width: 300px; height: 300px; position: relative;">
                        <canvas id="gaugeChart"></canvas>
                    </div>

                    <div id="recommendationBox" class="mt-4 p-4 rounded w-100"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                        <h6 class="fw-bold text-warning">üí° AI Retention Strategy</h6>
                        <p class="mb-0 text-white-50" id="insightText">Adjust sliders to see the generated AI plan...
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let gaugeChart;

        // Init Chart
        window.onload = function () {
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Risk', 'Safety'],
                    datasets: [{
                        data: [50, 50], // Initial dummy
                        backgroundColor: ['#dc3545', '#e9ecef'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });

            // Initial Call
            updateSim();
        };

        function resetDefaults() {
            document.getElementById('income').value = 6500;
            document.getElementById('hike').value = 15;
            document.getElementById('jobsat').value = 3;
            document.getElementById('wlb').value = 3;
            document.getElementById('overtime').checked = false;
            document.getElementById('remote').value = 0;

            // New defaults
            document.getElementById('age').value = 30;
            document.getElementById('tenure').value = 5;
            document.getElementById('dist').value = 9;
            document.getElementById('env').value = 3;

            updateSim();
        }

        async function updateSim() {
            // Update labels
            document.getElementById('val_income').innerText = document.getElementById('income').value;
            document.getElementById('val_hike').innerText = document.getElementById('hike').value;
            document.getElementById('val_jobsat').innerText = document.getElementById('jobsat').value;
            document.getElementById('val_wlb').innerText = document.getElementById('wlb').value;
            document.getElementById('val_remote').innerText = document.getElementById('remote').value;

            // New labels
            document.getElementById('val_age').innerText = document.getElementById('age').value;
            document.getElementById('val_tenure').innerText = document.getElementById('tenure').value;
            document.getElementById('val_dist').innerText = document.getElementById('dist').value;
            document.getElementById('val_env').innerText = document.getElementById('env').value;

            // Prepare payload
            // We only send the mutable fields, backend will fill rest with DEFAULT_VALUES
            const payload = {
                MonthlyIncome: parseFloat(document.getElementById('income').value),
                PercentSalaryHike: parseFloat(document.getElementById('hike').value),
                JobSatisfaction: parseFloat(document.getElementById('jobsat').value),
                WorkLifeBalance: parseFloat(document.getElementById('wlb').value),
                OverTime: document.getElementById('overtime').checked ? "Yes" : "No",
                RemoteWorkFrequency: parseFloat(document.getElementById('remote').value),

                // New Fields
                Age: parseFloat(document.getElementById('age').value),
                YearsAtCompany: parseFloat(document.getElementById('tenure').value),
                DistanceFromHome: parseFloat(document.getElementById('dist').value),
                EnvironmentSatisfaction: parseFloat(document.getElementById('env').value)
            };

            try {
                const res = await fetch('/api/predict_simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.error) {
                    console.error(data.error);
                    return;
                }

                // Update UI: Use 'probability' from backend (0.0 - 1.0) -> Score (0-100)
                const score = Math.round(data.probability * 100);
                const riskElem = document.getElementById('riskDisplay');
                riskElem.innerText = score + "%";

                // Color Logic
                let color = '#28a745'; // Green
                let alertClass = 'alert-success';

                if (score > 40) {
                    color = '#ffc107'; // Yellow
                    alertClass = 'alert-warning';
                }
                if (score > 70) {
                    color = '#dc3545'; // Red
                    alertClass = 'alert-danger';
                }

                riskElem.style.color = color;

                // Update Chart
                gaugeChart.data.datasets[0].data = [score, 100 - score];
                gaugeChart.data.datasets[0].backgroundColor = [color, '#e9ecef'];
                gaugeChart.update();

                // --- AI PLAN DISPLAY ---
                const recBox = document.getElementById('recommendationBox');
                const insightElem = document.getElementById('insightText');

                // Clear previous
                recBox.innerHTML = "";
                // recBox.className = "mt-4 p-4 rounded border w-100 alert " + alertClass; 
                // Using custom glass-alert style instead of standard alert class
                recBox.style.borderLeft = "5px solid " + color;

                // Add Header
                const h6 = document.createElement("h6");
                h6.className = "fw-bold mb-2";
                h6.innerHTML = "üí° AI Retention Strategy";
                recBox.appendChild(h6);

                // Add Summary
                if (data.ai_plan) {
                    const p = document.createElement("p");
                    p.className = "mb-2 fw-semibold";
                    p.innerText = data.ai_plan.summary;
                    recBox.appendChild(p);

                    // Add Actions List
                    if (data.ai_plan.actions && data.ai_plan.actions.length > 0) {
                        const ul = document.createElement("ul");
                        ul.className = "mb-0 ps-3 text-start small";
                        data.ai_plan.actions.forEach(action => {
                            const li = document.createElement("li");
                            // Allow simple bolding parsing
                            li.innerHTML = action.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            ul.appendChild(li);
                        });
                        recBox.appendChild(ul);
                    }
                } else {
                    const p = document.createElement("p");
                    p.innerText = "No specific plan available.";
                    recBox.appendChild(p);
                }

            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>