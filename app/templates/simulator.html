<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Attrition Simulator | AI Project</title>
    <!-- Bootstrap + Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        body {
            background: linear-gradient(180deg, #0f2a45, #0b3550);
            min-height: 100vh;
            color: #fff;
        }

        .card-box {
            background: #fff;
            border-radius: 14px;
            padding: 25px;
            color: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .range-wrap {
            position: relative;
            margin: 0 auto 3rem;
        }

        .range-value {
            position: absolute;
            top: -50%;
        }

        .range-value span {
            width: 30px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #03a9f4;
            color: #fff;
            font-size: 12px;
            display: block;
            position: absolute;
            left: 50%;
            transform: translate(-50%, 0);
            border-radius: 6px;
        }

        .range-value span:before {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-top: 10px solid #03a9f4;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            margin-top: -1px;
        }

        .sim-control-label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }

        .slider-val {
            font-weight: bold;
            color: #0d6efd;
            float: right;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg px-4 py-3" style="background: rgba(0,0,0,0.2);">
        <a class="navbar-brand d-flex align-items-center gap-2 text-white" href="/">
            <img src="{{ url_for('static', filename='logo.png') }}" height="32">
            <span class="fw-bold">ATTRITION SIMULATOR</span>
        </a>
        <div class="ms-auto">
            <a href="/" class="btn btn-outline-light btn-sm">Home</a>
            <a href="/dashboard" class="btn btn-outline-light btn-sm">Dashboard</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12 text-center mb-4">
                <h2 class="fw-bold">üéõÔ∏è Interactive Risk Simulator</h2>
                <p class="text-white-50">Tweak employee parameters and see how Attrition Risk changes in real-time.</p>
            </div>
        </div>

        <div class="row">
            <!-- CONTROLS -->
            <div class="col-lg-5 mb-4">
                <div class="card-box">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">Simulation Controls</h5>

                    <!-- Monthly Income -->
                    <div class="mb-4">
                        <label class="sim-control-label">Monthly Income ($) <span id="val_income"
                                class="slider-val">6500</span></label>
                        <input type="range" class="form-range" id="income" min="1000" max="20000" step="100"
                            value="6500" oninput="updateSim()">
                    </div>

                    <!-- Percent Salary Hike -->
                    <div class="mb-4">
                        <label class="sim-control-label">Salary Hike (%) <span id="val_hike"
                                class="slider-val">15</span></label>
                        <input type="range" class="form-range" id="hike" min="0" max="30" step="1" value="15"
                            oninput="updateSim()">
                    </div>

                    <!-- Job Satisfaction -->
                    <div class="mb-4">
                        <label class="sim-control-label">Job Satisfaction (1-4) <span id="val_jobsat"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="jobsat" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <!-- Work Life Balance -->
                    <div class="mb-4">
                        <label class="sim-control-label">Work Life Balance (1-4) <span id="val_wlb"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="wlb" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <!-- OverTime -->
                    <div class="mb-4 d-flex justify-content-between align-items-center">
                        <label class="sim-control-label mb-0">OverTime?</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="overtime" onchange="updateSim()">
                        </div>
                    </div>

                    <!-- Remote Work -->
                    <div class="mb-4">
                        <label class="sim-control-label">Remote Work Days (0-5) <span id="val_remote"
                                class="slider-val">0</span></label>
                        <input type="range" class="form-range" id="remote" min="0" max="5" step="1" value="0"
                            oninput="updateSim()">
                    </div>

                    <hr class="my-4">
                    <h6 class="fw-bold mb-3 text-primary">Other Key Factors</h6>

                    <!-- Age -->
                    <div class="mb-3">
                        <label class="sim-control-label">Age <span id="val_age" class="slider-val">30</span></label>
                        <input type="range" class="form-range" id="age" min="18" max="60" step="1" value="30"
                            oninput="updateSim()">
                    </div>

                    <!-- Years At Company -->
                    <div class="mb-3">
                        <label class="sim-control-label">Years At Company <span id="val_tenure"
                                class="slider-val">5</span></label>
                        <input type="range" class="form-range" id="tenure" min="0" max="40" step="1" value="5"
                            oninput="updateSim()">
                    </div>

                    <!-- Distance From Home -->
                    <div class="mb-3">
                        <label class="sim-control-label">Distance From Home (km) <span id="val_dist"
                                class="slider-val">9</span></label>
                        <input type="range" class="form-range" id="dist" min="1" max="30" step="1" value="9"
                            oninput="updateSim()">
                    </div>

                    <!-- Environment Satisfaction -->
                    <div class="mb-3">
                        <label class="sim-control-label">Environment Sat. (1-4) <span id="val_env"
                                class="slider-val">3</span></label>
                        <input type="range" class="form-range" id="env" min="1" max="4" step="1" value="3"
                            oninput="updateSim()">
                    </div>

                    <button class="btn btn-secondary w-100 mt-2" onclick="resetDefaults()">Reset Defaults</button>

                </div>
            </div>

            <!-- VISUALIZATION -->
            <div class="col-lg-7">
                <div class="card-box h-100 d-flex flex-column justify-content-center align-items-center text-center">

                    <h4 class="text-muted mb-1">Predicted Attrition Risk</h4>
                    <h1 class="display-1 fw-bold mb-3" id="riskDisplay">--%</h1>

                    <div style="width: 300px; height: 300px; position: relative;">
                        <canvas id="gaugeChart"></canvas>
                    </div>

                    <div id="recommendationBox" class="mt-4 p-3 rounded bg-light border w-100">
                        <h6 class="fw-bold">üí° Insight</h6>
                        <p class="mb-0 text-muted" id="insightText">Adjust sliders to see impact...</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let gaugeChart;

        // Init Chart
        window.onload = function () {
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Risk', 'Safety'],
                    datasets: [{
                        data: [50, 50], // Initial dummy
                        backgroundColor: ['#dc3545', '#e9ecef'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });

            // Initial Call
            updateSim();
        };

        function resetDefaults() {
            document.getElementById('income').value = 6500;
            document.getElementById('hike').value = 15;
            document.getElementById('jobsat').value = 3;
            document.getElementById('wlb').value = 3;
            document.getElementById('overtime').checked = false;
            document.getElementById('remote').value = 0;

            // New defaults
            document.getElementById('age').value = 30;
            document.getElementById('tenure').value = 5;
            document.getElementById('dist').value = 9;
            document.getElementById('env').value = 3;

            updateSim();
        }

        async function updateSim() {
            // Update labels
            document.getElementById('val_income').innerText = document.getElementById('income').value;
            document.getElementById('val_hike').innerText = document.getElementById('hike').value;
            document.getElementById('val_jobsat').innerText = document.getElementById('jobsat').value;
            document.getElementById('val_wlb').innerText = document.getElementById('wlb').value;
            document.getElementById('val_remote').innerText = document.getElementById('remote').value;

            // New labels
            document.getElementById('val_age').innerText = document.getElementById('age').value;
            document.getElementById('val_tenure').innerText = document.getElementById('tenure').value;
            document.getElementById('val_dist').innerText = document.getElementById('dist').value;
            document.getElementById('val_env').innerText = document.getElementById('env').value;

            // Prepare payload
            // We only send the mutable fields, backend will fill rest with DEFAULT_VALUES
            const payload = {
                MonthlyIncome: parseFloat(document.getElementById('income').value),
                PercentSalaryHike: parseFloat(document.getElementById('hike').value),
                JobSatisfaction: parseFloat(document.getElementById('jobsat').value),
                WorkLifeBalance: parseFloat(document.getElementById('wlb').value),
                OverTime: document.getElementById('overtime').checked ? "Yes" : "No",
                RemoteWorkFrequency: parseFloat(document.getElementById('remote').value),

                // New Fields
                Age: parseFloat(document.getElementById('age').value),
                YearsAtCompany: parseFloat(document.getElementById('tenure').value),
                DistanceFromHome: parseFloat(document.getElementById('dist').value),
                EnvironmentSatisfaction: parseFloat(document.getElementById('env').value)
            };

            try {
                const res = await fetch('/api/predict_simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.error) {
                    console.error(data.error);
                    return;
                }

                // Update UI
                const score = data.risk_score;
                const riskElem = document.getElementById('riskDisplay');
                riskElem.innerText = score + "%";

                // Color Logic
                let color = '#28a745'; // Green
                let alertClass = 'alert-success';

                if (score > 40) {
                    color = '#ffc107'; // Yellow
                    alertClass = 'alert-warning';
                }
                if (score > 70) {
                    color = '#dc3545'; // Red
                    alertClass = 'alert-danger';
                }

                riskElem.style.color = color;

                // Update Chart
                gaugeChart.data.datasets[0].data = [score, 100 - score];
                gaugeChart.data.datasets[0].backgroundColor = [color, '#e9ecef'];
                gaugeChart.update();

                // Generate Insight
                let insight = "";
                if (score < 30) insight = "‚úÖ This employee is very safe.";
                else if (score < 60) insight = "‚ö†Ô∏è Moderate risk.";
                else insight = "üö® HIGH RISK! Immediate intervention needed.";

                const recBox = document.getElementById('recommendationBox');
                const insightElem = document.getElementById('insightText');

                // Reset classes
                recBox.className = "mt-4 p-3 rounded border w-100 alert " + alertClass;

                insightElem.innerText = insight;
                insightElem.style.color = ""; // Reset inline color
                insightElem.style.fontWeight = "bold";
                insightElem.classList.remove("text-muted");

            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>